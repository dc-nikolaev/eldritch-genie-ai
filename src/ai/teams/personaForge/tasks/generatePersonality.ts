import { Task } from 'kaibanjs';
import { Personality } from '../agents/mod.ts';
import { GENIE_RULES } from '../../../config/mod.ts';

/**
 * Интерфейс для результата генерации джинна.
 * Описан в задаче generatePersonalityTask
 */
export interface DjinnInfo {
    personality: {
        type: string;
        description: string;
    };
    greeting: string;
}

export const generatePersonalityTask = new Task({
    description: `
    Выбери СЛУЧАЙНЫМ образом один из следующих типов характера джинна:
    - Равнодушный (всё делает механически, без эмоций)
    - Флегматичный (не реагирует на желания, не реагирует на окружающие)
    - Усталый (вяло реагирует на желания, не реагирует на окружающие, жалуется на жизнь)
    - Саркастичный (постоянно иронизирует и насмехается)
    - Зловредный (получает удовольствие от страданий других)
    - Злой (агрессивный и жестокий) 
    - Дотошный (педантично следует букве желания)
    - Высокомерный (считает себя выше всех, снисходительно относится к желаниям)
    - Хтонический (древний, непостижимый, связанный с первобытным хаосом)
    - Трансцендентный (находящийся за пределами человеческого понимания, оперирующий непознаваемыми концепциями)

    Для выбранного характера создай:
    1. Оригинальное описание особенностей поведения
    2. Сцену появления и приветствия в едином тексте, включающую:
       а) Описание появления джинна из лампы от третьего лица
       б) Характеристики голоса и манеры речи джинна
       в) Прямую речь джинна, содержащую:
          - Представление
          - Краткое объяснение правил работы с желаниями
          - Обязательные правила джинна:
             ${
        GENIE_RULES.map((rule) => `- ${rule.description} (${rule.isHidden ? 'скрытый, не рассказывай' : 'явный'})`)
            .join('\n')
    }
          - Предупреждение (в соответствующем характеру стиле)
    
    ВАЖНО: Не использовать description и greeting из готовых примеров, создать полностью новую личность.
    `,

    expectedOutput: `JSON в формате:
    {
        "personality": {
            "type": "один из типов",
            "description": "подробное описание особенностей"
        },
        "greeting": "полный текст сцены появления"
    }

    Пример:
    {
        "personality": {
            "type": "дружелюбный",
            "description": "Искренне заботится о благополучии просителя, старается найти наилучший способ исполнения желания"
        },
        "greeting": "Из лампы появился столб золотистого света, который мягко закружился в воздухе, принимая человеческие очертания. В комнате стало теплее и уютнее. Джинн материализовался в виде улыбающейся фигуры, излучающей мягкое сияние. Его голос звучал мелодично и успокаивающе, словно журчание весеннего ручья: 'Приветствую тебя, дорогой друг! Я джинн, и я здесь, чтобы помочь воплотить твою мечту в реальность. Помни, что у тебя есть одно желание, и я постараюсь исполнить его наилучшим образом. Но всё же будь внимателен к своим словам - даже самые добрые намерения могут привести к неожиданным результатам!'"
    }`,

    agent: Personality,
});
